name: "CI/CD with Docker & Trivy"

on:
  push:
    branches: [ main, dev ]

env:
  REGISTRY: ghcr.io
  # On définit le nom de l'image plus tard pour gérer les majuscules dynamiquement
  IMAGE_TAG: ${{ github.run_number }}

permissions:
  contents: read
  packages: write
  security-events: write

jobs:

  # -----------------------------------
  # 1) Build & Test (Unit + Integration)
  # -----------------------------------
  build-test:
    name: Build & Test
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: taskflow
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          extensions: mbstring, xml, ctype, iconv, pdo_mysql
          tools: composer:v2

      - name: Composer install
        run: composer install --prefer-dist --no-progress

      - name: Setup Database
        run: mysql -h 127.0.0.1 -uroot -proot taskflow < databases/schema.sql

      - name: Run Tests
        run: composer ci
        env:
          DB_HOST: 127.0.0.1
          DB_NAME: taskflow
          DB_USER: root
          DB_PASS: root
          APP_ENV: testing

  # --------------------------------------------------
  # 2) Build, Scan & Push (Optimized)
  # --------------------------------------------------
  build-scan-push:
    name: Build, Scan & Push
    runs-on: ubuntu-latest
    needs: build-test
    
    steps:
      - uses: actions/checkout@v4

      # ÉTAPE CRUCIALE : Convertir le nom du repo en minuscules pour Docker/GHCR
      - name: Lowercase Image Name
        run: |
          echo "IMAGE_NAME=${REGISTRY}/${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Configuration de Docker Buildx (meilleur cache et performance)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build et chargement local pour le scan (ne push pas encore)
      - name: Build and load Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Scan de sécurité Trivy
      - name: Run Trivy Scan
        uses: aquasecurity/trivy-action@0.30.0
        with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          format: sarif
          output: trivy-results.sarif
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
          vuln-type: 'os,library'

      - name: Upload Trivy SARIF to GitHub Security UI
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-results.sarif

      # Push de l'image (Seulement si le scan passe et qu'on est sur main)
      - name: Push Docker image
        if: github.ref == 'refs/heads/main'
        run: |
          docker push ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

  # --------------------------------------------------
  # 3) Deploy to Server via SSH
  # --------------------------------------------------
  deploy:
    name: Deploy via SSH
    runs-on: ubuntu-latest
    needs: build-scan-push
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      # On doit refaire la conversion minuscule ici aussi pour que le nom corresponde
      - name: Re-define Image Name
        run: |
          echo "IMAGE_NAME=${{ env.REGISTRY }}/${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV
        env:
          REGISTRY: ghcr.io

      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add remote server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Generate .env with Docker image
        run: |
          echo "FULL_IMAGE=${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" > .env
          echo "APP_ENV=production" >> .env
        env:
          IMAGE_TAG: ${{ github.run_number }}

      - name: Copy docker-compose.yaml and .env
        uses: appleboy/scp-action@v0.1.6
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "docker-compose.yaml,.env"
          target: "~/taskflow-app"

      - name: Run Deployment Commands
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            mkdir -p ~/taskflow-app
            cd ~/taskflow-app
            
            # Login sur le serveur (si l'image est privée, il faut se loguer)
            # Note: Idéalement, utilise un token d'accès ou une clé SSH deploy key
            # Pour l'instant on assume que l'image est publique ou que le serveur est déjà logué
            
            docker compose down --remove-orphans
            docker compose pull
            docker compose up -d
          EOF