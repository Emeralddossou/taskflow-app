name: "CI/CD with Docker & Trivy"

on:
  push:
    branches: [ main, dev ]

env:
  IMAGE_NAME: ghcr.io/emerald-dossou/taskflow-app  # tout en minuscules
  IMAGE_TAG: ${{ github.sha }}

permissions:
  contents: read
  packages: write   # requis pour pousser sur GHCR
  security-events: write  # requis pour Trivy SARIF upload

jobs:

  # -----------------------------------
  # 1) Build & Test (Unit + Integration)
  # -----------------------------------
  build-test:
    name: Build & Test
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: taskflow
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          extensions: mbstring, xml, ctype, iconv, pdo_mysql
          tools: composer:v2

      - name: Composer install
        run: composer install --prefer-dist --no-progress

      - name: Setup Database
        run: mysql -h 127.0.0.1 -uroot -proot taskflow < databases/schema.sql

      - name: Run Tests
        run: composer ci
        env:
          DB_HOST: 127.0.0.1
          DB_NAME: taskflow
          DB_USER: root
          DB_PASS: root
          APP_ENV: testing

  # --------------------------------------------------
  # 2) Build Docker Image + Scan (Trivy) BEFORE Push
  # --------------------------------------------------
  build-scan:
    name: Build & Scan Docker Image
    runs-on: ubuntu-latest
    needs: build-test

    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t $IMAGE_NAME:$IMAGE_TAG .

      - name: Run Trivy Scan
        env:
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        uses: aquasecurity/trivy-action@0.30.0
        with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          format: sarif
          output: trivy-results.sarif
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
          vuln-type: 'os,library'
        
      - name: Upload Trivy SARIF to GitHub Security UI
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-results.sarif

  # --------------------------------------------------
  # 3) Push image to GitHub Container Registry (main only)
  # --------------------------------------------------
  push-image:
    name: Push to GHCR
    runs-on: ubuntu-latest
    needs: build-scan
    if: github.ref == 'refs/heads/main'

    env:
      IMAGE_NAME: ghcr.io/emerald-dossou/taskflow-app
      IMAGE_TAG: ${{ github.sha }}

    steps:
      - uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Docker image (again)
        run: |
          docker build -t ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} .

      - name: Tag & Push Image
        run: |
          docker push ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

  # --------------------------------------------------
  # 4) Deploy to Server via SSH + Docker Compose
  # --------------------------------------------------
  deploy:
    name: Deploy via SSH
    runs-on: ubuntu-latest
    needs: push-image
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add remote server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Generate .env with Docker image
        run: |
          echo "FULL_IMAGE=${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" > .env
        

      - name: Copy docker-compose.yml to server
        uses: appleboy/scp-action@v0.1.6
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "docker-compose.yml,.env"
          target: "~/taskflow-app"

      - name: Run Deployment Commands
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            mkdir -p ~/taskflow-app
            cd ~/taskflow-app
            docker compose pull || exit 1
            docker compose up -d || exit 1
          EOF
